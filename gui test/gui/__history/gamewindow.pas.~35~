unit gamewindow;

interface

uses
  Windows, Messages, Memory, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Addresses, map;

type
  TGameWindow = class
  private

    FMap: TMap;

  public

    function getSize(): TRect;
    function getSize2(): TRect;
    function absoluteToCursor( x,y: integer ): TRect;
function GetGameWindow(): TRect;

    property Map: TMap read FMap;

  published
    constructor Create; overload;
    destructor Destroy; override;
  end;

var
Memory: TMemory;

implementation

uses
  Unit1;

constructor TGameWindow.Create;
begin
  inherited;

  FMap := TMap.Create;
end;

destructor TGameWindow.Destroy;
begin
  FMap.Free;

  inherited;
end;
                     {function from a guy in tpforum... but doesnt work... wtf}
function TGameWindow.GetGameWindow(): TRect;
var
p,offset1,offset2,rx,ry,rw,rh: integer;
begin
 p := Memory.ReadInteger(Addresses.GUIPointer);
             offset1 := Memory.ReadInteger(p + Addresses.ClientGameWindow);
             offset2 := Memory.ReadInteger(offset1 + Addresses.ClientFirstChild);

             rx := Memory.ReadInteger(offset2 + Addresses.ClientY);
             ry := Memory.ReadInteger(offset2 + Addresses.ClientY);
             rw := Memory.ReadInteger(offset2 + Addresses.ClientWidth);
             rh := Memory.ReadInteger(offset2 + Addresses.ClientHeight);
             showmessage(inttostr(rw));
         //   result:= new Rectangle(rx, ry, rw, rh);
   result.Left := rx;
  result.Top := ry;
  result.Right := rw;
  result.Bottom :=rh;
  end;


function TGameWindow.getSize(): TRect;
var
  tmp, i: integer;
begin
  tmp := Memory.ReadPointer( Addresses.guiPointer, [ $30, $24 ] ); // game window

  result.Left := Memory.ReadInteger( tmp + $14);
  result.Top := Memory.ReadInteger( tmp + $18);
  result.Right := Memory.ReadInteger( tmp + $1c);
  result.Bottom := Memory.ReadInteger( tmp + $20);
end;

function TGameWindow.getSize2(): TRect;
var
  num, i,x ,y: integer;
  r: TRect;
begin
getwindowrect(Main.THand,r); //not working, idk why......
       num := Memory.ReadInteger(Integer(ADDR_BASE) +GUIpointer);
       x := Memory.ReadInteger(num + 20);
       y := Memory.ReadInteger(num + $18);
     showmessage(inttostr(r.Right-r.Left)+':X  '+inttostr(r.Bottom-r.Top)+':Y  ');
end;

function TGameWindow.absoluteToCursor( x,y: integer ): TRect;
var
  r: TRect;
  player: TPoint;
  tileWidth, tileHeight: integer;
begin

  r := getSize();
  player.X := Memory.ReadInteger( addresses.selfX );
  player.Y := Memory.ReadInteger( addresses.selfY );

  tileWidth := round( r.Right / 15 );   // 7 de cada lado + 1 del char
  tileHeight := round( r.Bottom / 11 );   // 5 de cada lado + 1 del char

  player.X := player.X - 7; // x lewego górnego rogu
  player.Y := player.Y - 5; // y lewego górnego rogu

  result.Left := x - player.X;
  result.Top := y - player.Y;

  result.Left := (tileWidth * result.Left);
  result.Top := (tileHeight * result.Top);
  result.Right := tileWidth;
  result.Bottom := tileHeight;

end;

end.
